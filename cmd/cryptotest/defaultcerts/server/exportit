#Convert the original jks to p12
rm twlserver.p12
rm truststore.p12

keytool -importkeystore \
        -srcstorepass password \
        -deststorepass password \
        -srckeystore originals/twlserver.jks \
        -destkeystore twlserver.p12 \
        -srcstoretype jks \
        -deststoretype pkcs12

#Export the entire server cert chain as a client trust
openssl pkcs12 \
	-password pass:password \
        -in twlserver.p12 -nodes -nokeys > server.trust.pem
cp server.trust.pem ../clients/client.trust.pem

#Export the p12 to pem for the sake of the server
openssl pkcs12 \
	-password pass:password \
	-in twlserver.p12 -clcerts -nokeys > server.cert.pem  
openssl pkcs12 \
	-password pass:password \
	-in twlserver.p12 -clcerts -nocerts -nodes > server.key.pem  

keytool -importkeystore \
        -srcstorepass password \
        -deststorepass password \
        -srckeystore originals/truststore.jks \
        -destkeystore truststore.p12 \
        -srcstoretype jks \
        -deststoretype pkcs12
openssl pkcs12 \
	-password pass:password \
	-in truststore.p12 -nodes -nokeys > trust.pem

for i in `seq 0 9`
do
openssl pkcs12 \
	-password pass:password \
	-in ../clients/test_${i}.p12 -clcerts -nokeys >> trust.pem
openssl pkcs12 \
	-password pass:password \
	-in ../clients/test_${i}.p12 -clcerts -nokeys > ../clients/test_${i}.cert.pem
openssl pkcs12 \
	-password pass:password \
	-in ../clients/test_${i}.p12 -nodes -nocerts > ../clients/test_${i}.key.pem
done

cp trust.pem ../clients/client.trust.pem
cp trust.pem server.trust.pem
