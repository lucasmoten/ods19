machine:
    environment:
        IMPORT_PATH: "decipher.com/object-drive-server"
        REPO_NAME: "object-drive-server"
        ODRIVE_VERSION: "1.0.1"
    hosts:
        kafka: 127.0.0.1
    pre:
        - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    services:
        - docker


dependencies:
    pre:
        - sudo pip install docker-compose
        - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
        - go get -u github.com/kardianos/govendor
        - go get -u github.com/jteeuwen/go-bindata/...
    override:
        - mkdir -p ~/.go_workspace/src/$IMPORT_PATH
        - rm -rf ~/.go_workspace/src/$IMPORT_PATH
        - cp -rf ~/$REPO_NAME ~/.go_workspace/src/$IMPORT_PATH
        - cd ~/.go_workspace/src/$IMPORT_PATH && govendor sync
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive && go build
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && go-bindata schema ../../defaultcerts/client-mysql/id ../../defaultcerts/client-mysql/trust
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && go build
        - cd ~/.go_workspace/src/$IMPORT_PATH && docker build -t deciphernow/odrive:latest .
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose pull zk kafka aac metadatadb gatekeeper dias
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose up -d

test:
    override:
        -  cd ~/.go_workspace/src/$IMPORT_PATH && GOPATH=~/.go_workspace go test ./...

deployment:
    hub:
        branch: develop
        commands:
            - cd ~/.go_workspace/src/$IMPORT_PATH && ./makerpm $CIRCLE_BUILD_NUM
            - cd ~/.go_workspace/src/$IMPORT_PATH && mv odrive-${CIRCLE_BUILD_NUM}-1.x86_64.rpm odrive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}-1.x86_64.rpm
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp odrive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}-1.x86_64.rpm s3://odrive-builds/circle/rpms/odrive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}-1.x86_64.rpm

