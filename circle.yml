machine:
    java:
        version: openjdk7
    environment:
        IMPORT_PATH: "decipher.com/object-drive-server"
        REPO_NAME: "object-drive-server"
        ODRIVE_VERSION: "1.0.4"
        GOPATH: "/home/ubuntu/.go_workspace"
        OD_ROOT: "/home/ubuntu/od_root"
    hosts:
        kafka: 127.0.0.1
        metadatadb: 127.0.0.1
        zk: 127.0.0.1
        aac: 127.0.0.1
    pre:
        - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    services:
        - docker


dependencies:
    pre:
        - sudo pip install docker-compose
        - sudo apt-get install graphviz
        - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
        - go get -u github.com/kardianos/govendor
        - go get -u github.com/jteeuwen/go-bindata/...
    override:
        - mkdir -p ~/.go_workspace/src/$IMPORT_PATH
        - rm -rf ~/.go_workspace/src/$IMPORT_PATH
        - cp -rf ~/$REPO_NAME ~/.go_workspace/src/$IMPORT_PATH
        - cd ~/.go_workspace/src/$IMPORT_PATH && govendor sync
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive && go build -ldflags "-X main.Build=${CIRCLE_BUILD_NUM} -X main.Commit=${CIRCLE_SHA1} -X main.Version=$(git describe --abbrev=0 --tags)"
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/obfuscate && go build
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && go-bindata schema migrations ../../defaultcerts/client-mysql/id ../../defaultcerts/client-mysql/trust
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && go build -ldflags "-X main.Build=${CIRCLE_BUILD_NUM} -X main.Commit=${CIRCLE_SHA1} -X main.Version=$(git describe --abbrev=0 --tags)"
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./makedocs
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./odb --build -i deciphernow/odrive -t latest
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./odb --build -i deciphernow/metadatadb -t latest
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose pull zk kafka aac gatekeeper dias
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose up -d

test:
    override:
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && ./odrive-database debug > db.yml
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && CONTAINERIP=$(docker inspect -f '{{.NetworkSettings.IPAddress }}' $(docker ps -a | grep metadatadb | awk '{print $1}')) sed -i "s/127.0.0.1/$CONTAINERIP/g" db.yml
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && ./odrive-database init --conf db.yml --force=true
        - cd ~/.go_workspace/src/$IMPORT_PATH && GOPATH=~/.go_workspace && go test `go list ./... | grep -v vendor`

deployment:
    hub:
        branch: develop
        commands:
            - cd ~/.go_workspace/src/$IMPORT_PATH && ./makerpm $CIRCLE_BUILD_NUM $(git describe --abbrev=0 --tags):
                    timeout: 1200
            - cd ~/.go_workspace/src/$IMPORT_PATH && mv object-drive-1.0-${CIRCLE_BUILD_NUM}-SNAPSHOT.x86_64.rpm object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm s3://odrive-builds/circle/rpms/object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm --acl public-read
            - docker push deciphernow/odrive:latest
            - docker push deciphernow/metadatadb:latest
    release:
        tag: /v.*/
        owner: DecipherNow
        commands:
            - cd ~/.go_workspace/src/$IMPORT_PATH && ./makerpm $CIRCLE_BUILD_NUM $(git describe --abbrev=0 --tags):
                    timeout: 1200
            - cd ~/.go_workspace/src/$IMPORT_PATH && mv object-drive-1.0-${CIRCLE_BUILD_NUM}-SNAPSHOT.x86_64.rpm object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm s3://odrive-builds/circle/rpms/object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm --acl public-read
            
            - docker push deciphernow/odrive:latest
            - docker tag deciphernow/odrive:latest deciphernow/odrive:$CIRCLE_TAG
            - docker push deciphernow/odrive:$CIRCLE_TAG
            
            - docker push deciphernow/metadatadb:latest 
            - docker tag deciphernow/metadatadb:latest deciphernow/metadatadb:$CIRCLE_TAG
            - docker push deciphernow/metadatadb:$CIRCLE_TAG
