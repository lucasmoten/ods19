machine:
    java:
        version: openjdk7
    environment:
        IMPORT_PATH: "github.com/deciphernow/object-drive-server"
        REPO_NAME: "object-drive-server"
        ODRIVE_VERSION: "1.0.13"
        GOPATH: "/home/ubuntu/.go_workspace"
        OD_ROOT: "/home/ubuntu/od_root"
    hosts:
        odrive: 127.0.0.1
        proxier: 127.0.0.1
        kafka: 127.0.0.1
        metadatadb: 127.0.0.1
        zk: 127.0.0.1
        aac: 127.0.0.1
        redis: 127.0.0.1
    pre:
        - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    services:
        - docker


dependencies:
    pre:
        - pip install #upgrade pip
        - pip install docker-compose
        - sudo apt-get install graphviz
        - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
        - go get -u github.com/kardianos/govendor
        - go get -u github.com/jteeuwen/go-bindata/...
    override:
        - mkdir -p ~/.go_workspace/src/$IMPORT_PATH
        - rm -rf ~/.go_workspace/src/$IMPORT_PATH
        - cp -rf ~/$REPO_NAME ~/.go_workspace/src/$IMPORT_PATH
        - cd ~/.go_workspace/src/$IMPORT_PATH && govendor sync
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Build=${CIRCLE_BUILD_NUM} -X main.Commit=${CIRCLE_SHA1} -X main.Version=$(git describe --abbrev=0 --tags)"
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/obfuscate && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && go-bindata schema migrations ../../defaultcerts/client-mysql/id ../../defaultcerts/client-mysql/trust
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Build=${CIRCLE_BUILD_NUM} -X main.Commit=${CIRCLE_SHA1} -X main.Version=$(git describe --abbrev=0 --tags)"
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./makedocs ${ODRIVE_VERSION} ${CIRCLE_BUILD_NUM}
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./odb --build -i deciphernow/odrive -t latest
        - cd ~/.go_workspace/src/$IMPORT_PATH && ./odb --build -i deciphernow/metadatadb -t latest
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose pull zk kafka aac proxier dias redis
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose up -d
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose ps
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose logs odrive
        - cd ~/.go_workspace/src/$IMPORT_PATH/.ci && docker-compose logs proxier

test:
    override:
        - export OD_EXTERNAL_HOST=$(docker inspect -f '{{.NetworkSettings.IPAddress }}' $(docker ps -a | grep proxier | awk '{print $1}'))
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && export OD_DB_HOST=$(docker inspect -f '{{.NetworkSettings.IPAddress }}' $(docker ps -a | grep metadatadb | awk '{print $1}'))
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && ./odrive-database debug > db.yml
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && CONTAINERIP=$(docker inspect -f '{{.NetworkSettings.IPAddress }}' $(docker ps -a | grep metadatadb | awk '{print $1}')) sed -i "s/127.0.0.1/$CONTAINERIP/g" db.yml
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && cat db.yml
        - cd ~/.go_workspace/src/$IMPORT_PATH/cmd/odrive-database && ./odrive-database init --conf db.yml --force=true
        - cd ~/.go_workspace/src/$IMPORT_PATH/scripts/init.d && ./func-test.py
        - cd ~/.go_workspace/src/$IMPORT_PATH && GOPATH=~/.go_workspace && go test -v `go list ./... | grep -v vendor`:
                timeout: 1200

deployment:
    hub:
        branch: develop
        commands:
            - cd ~/.go_workspace/src/$IMPORT_PATH && ./makerpm $ODRIVE_VERSION $CIRCLE_BUILD_NUM $(git describe --abbrev=0 --tags):
                    timeout: 1200
            - cd ~/.go_workspace/src/$IMPORT_PATH && mv object-drive-1.0-${ODRIVE_VERSION}-${CIRCLE_BUILD_NUM}.$(date +%Y%m%d).x86_64.rpm object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm s3://odrive-builds/circle/rpms/develop/$(date +%Y%m)/object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm --acl private
            - docker push deciphernow/odrive:latest
            - docker push deciphernow/metadatadb:latest
    release:
        tag: /v.*/
        owner: DecipherNow
        commands:
            - cd ~/.go_workspace/src/$IMPORT_PATH && ./makerpm $ODRIVE_VERSION $CIRCLE_BUILD_NUM $(git describe --abbrev=0 --tags):
                    timeout: 1200
            - cd ~/.go_workspace/src/$IMPORT_PATH && mv object-drive-1.0-${ODRIVE_VERSION}-${CIRCLE_BUILD_NUM}.$(date +%Y%m%d).x86_64.rpm object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm s3://odrive-builds/circle/rpms/develop/$(date +%Y%m)/object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm --acl private            
            - cd ~/.go_workspace/src/$IMPORT_PATH && aws s3 cp object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm s3://odrive-builds/circle/rpms/release/object-drive-${ODRIVE_VERSION}.${CIRCLE_BUILD_NUM}.x86_64.rpm --acl private
            
            - docker push deciphernow/odrive:latest
            - docker tag deciphernow/odrive:latest deciphernow/odrive:$CIRCLE_TAG
            - docker push deciphernow/odrive:$CIRCLE_TAG
            
            - docker push deciphernow/metadatadb:latest 
            - docker tag deciphernow/metadatadb:latest deciphernow/metadatadb:$CIRCLE_TAG
            - docker push deciphernow/metadatadb:$CIRCLE_TAG
