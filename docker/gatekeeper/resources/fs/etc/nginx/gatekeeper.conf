
    # TODO we are addressing AAC directly from AppServer, currently.
    upstream aac {
        server aac:7444;
    }

    server {
        listen 443 ssl default_server;
        ssl on;

        keepalive_timeout   70;

        # Do not buffer requests or responses
        proxy_request_buffering off;
        proxy_buffering off;

        # SSL configs for connection to nginx
        ssl_certificate /etc/nginx/server.cert.pem;
        ssl_certificate_key /etc/nginx/server.key.pem;
        ssl_client_certificate /etc/nginx/server.trust.pem;
        ssl_trusted_certificate /etc/nginx/server.trust.pem;
        ssl_verify_depth 10;
        ssl_verify_client on;
        ssl_prefer_server_ciphers on;
        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # allow underscores in headers
        underscores_in_headers on;

        # other headers for service
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_pass_request_headers on;

        # SSL configs for connection to client, based on NGINX certificates
        # note: this sets SSL_CLIENT_S_DN header automatically
        proxy_ssl_name twl-server-generic2;
        proxy_ssl_certificate         /etc/nginx/server.cert.pem;
        proxy_ssl_certificate_key     /etc/nginx/server.key.pem;
        proxy_ssl_trusted_certificate /etc/nginx/server.trust.pem;
        proxy_ssl_verify_depth  10;
        proxy_ssl_verify        on;
        proxy_ssl_session_reuse on;
        proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
        proxy_ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4';


        # Object Drive JavaScript SPA
        location /app/hyperdrive {
            expires -1;
            alias /usr/local/var/www/app/objectdrive/dist/;
        }

        set $ssl_client_s_dn_value $ssl_client_s_dn;

        location /service/dctc/ {
                expires -1;
                #set $user_dn_value $ssl_client_s_dn_value;
                #set $user_dn_value "CN=Zuniga Brenda cnzunib,OU=people,OU=dia,OU=dod,O=U.S. Government,C=us";

            	# determine USER_DN and EXTERNAL_SYS_DN (if USER_DN exists, impersonation is true)
            	set $user_dn_value $ssl_client_s_dn;
            	set $external_sys_dn_value '';
            	if ($http_user_dn) {
                    set $user_dn_value $http_user_dn;
                    set $external_sys_dn_value $ssl_client_s_dn_value;
            	}
        }

        ######
        #Chimera Service Routes
        ######

        location /service/aac/1.0/ {
            expires -1;
            set $user_dn_value $ssl_client_s_dn;
            set $external_sys_dn_value '';
            if ($http_user_dn) {
                    set $user_dn_value $http_user_dn;
                    set $external_sys_dn_value $ssl_client_s_dn_value;
            }
            proxy_set_header EXTERNAL_SYS_DN $external_sys_dn_value;
            proxy_set_header USER_DN $user_dn_value;
            proxy_pass              https://aac/;
        }

        # TODO we will need to change this if we change our service route.
        location /services/object-drive/1.0/ {
            expires -1;
            set $user_dn_value $ssl_client_s_dn;
            set $external_sys_dn_value '';
            if ($http_user_dn) {
                    set $user_dn_value $http_user_dn;
                    set $external_sys_dn_value $ssl_client_s_dn_value;
            }
            proxy_set_header EXTERNAL_SYS_DN $external_sys_dn_value;
            proxy_set_header USER_DN $user_dn_value;
            proxy_pass            https://odrive:4430/;
            proxy_set_header      Host  bedrock.363-283.io:443;
            proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header      X-Real-IP $remote_addr;
        }

        location /service/auditservice/1.0 {
            expires -1;
            set $user_dn_value $ssl_client_s_dn;
            set $external_sys_dn_value '';
            if ($http_user_dn) {
                    set $user_dn_value $http_user_dn;
                    set $external_sys_dn_value $ssl_client_s_dn_value;
            }
            proxy_set_header EXTERNAL_SYS_DN $external_sys_dn_value;
            proxy_set_header USER_DN $user_dn_value;
            proxy_pass  https://10.2.11.46:10443/bedrock/services/audit_service;
            proxy_set_header      Host  bedrock.363-283.io:10443;
            proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header      X-Real-IP $remote_addr;
        }

        location /service/userservice/1.0 {
            expires -1;
            proxy_pass            https://chm.363-283.io/service/userservice/1.0;
            proxy_set_header      Host  bedrock.363-283.io:443;
            proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header      X-Real-IP $remote_addr;
        }

        ######
        #Error Pages
        ######

        # No SSL? Display an error page
        error_page 495 496 497 = @no_ssl;
        location @no_ssl {
                expires -1;
                internal;
                try_files $uri /error/pkiNotFound.html /;
        }

        # Send all other service requests to Chimera APIs page
        location /service {
                expires -1;
                try_files /service/chimeraAPIs.html /;
        }
    }
